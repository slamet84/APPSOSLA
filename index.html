<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Input Opname</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { background: #e6f7fa; }
    .container { max-width: 650px; margin: 40px auto; background: #fff; border-radius: 18px; box-shadow: 0 2px 12px #0001; padding: 2.5rem 2.5rem 2rem 2.5rem;}
    h1 { color: #00806a;}
    .btn { background: #00806a; color: #fff; border: none; border-radius: 8px; padding: 12px 18px; font-size: 1.1rem; margin: 0 10px; font-weight: bold; cursor:pointer; box-shadow: 0 2px 6px #0001; transition: background .2s;}
    .btn:hover { background: #00594c;}
    #uploadSaldoStatus { margin-left: 1rem; color:#00806a; font-weight:bold;}
    @media (max-width:600px) { .container { padding:1rem;} .btn { padding: 12px 8px; margin: 5px 3px;}}
    table { border-collapse: collapse; width:100%; margin-top:1.5rem;}
    th, td { border:1px solid #ddd; padding: 8px;}
    th { background: #e0f7f1;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Input Saldo Awal</h1>
    <!-- Contoh: Pilih jenis -->
    <div style="margin-bottom:1rem;">
      <label><input type="radio" name="jenisSaldo" value="perlengkapan" checked /> Saldo Awal Perlengkapan</label>
      <label><input type="radio" name="jenisSaldo" value="persediaan" style="margin-left:1rem;"/> Saldo Awal Persediaan</label>
    </div>
    <!-- Form upload saldo awal (Excel, dst) -->
    <input type="file" id="fileInput" accept=".json,.xls,.xlsx,.csv" class="btn"/>
    <button id="saveSaldoBtn" class="btn">Simpan Saldo Awal</button>

    <!-- Tombol upload saldo awal ke cloud -->
    <button id="uploadSaldoAwalCloud" class="btn">Upload Saldo Awal ke Cloud</button>
    <span id="uploadSaldoStatus"></span>

    <!-- Tabel preview saldo awal -->
    <table id="saldoAwalPreview" style="display:none">
      <thead>
        <tr><th>Kode</th><th>Nama</th><th>Jumlah</th></tr>
      </thead>
      <tbody id="saldoAwalTable"></tbody>
    </table>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // Supabase config
    const SUPABASE_URL = 'https://yxwxqlufyzxroomjbuqh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4d3hxbHVmeXp4cm9vbWpidXFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwNDYxNDUsImV4cCI6MjA2NTYyMjE0NX0.wIlqtvkERpdHPaGyg8JufZL10M1noTi6hvTD6HPC36Q';
    const BUCKET_NAME = 'uploads';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let saldoAwalData = [];
    let fileName = "";

    // Pilih jenis saldo
    function getJenisSaldo() {
      return document.querySelector('input[name="jenisSaldo"]:checked').value;
    }

    // Baca file dan preview saldo awal
    document.getElementById("fileInput").addEventListener("change", function(e){
      const file = e.target.files[0];
      if (!file) return;
      fileName = file.name.replace(/\.[^/.]+$/, ""); // tanpa ekstensi
      const reader = new FileReader();
      reader.onload = function(evt) {
        let data = [];
        if (file.name.endsWith('.json')) {
          data = JSON.parse(evt.target.result);
        } else {
          const workbook = XLSX.read(evt.target.result, {type: 'binary'});
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          data = XLSX.utils.sheet_to_json(sheet);
        }
        saldoAwalData = data;
        displaySaldoAwal();
      };
      if (file.name.endsWith('.json')) {
        reader.readAsText(file);
      } else {
        reader.readAsBinaryString(file);
      }
    });

    // Tampilkan saldo awal yang sudah dibaca
    function displaySaldoAwal() {
      const tbody = document.getElementById("saldoAwalTable");
      if (!saldoAwalData || saldoAwalData.length === 0) {
        tbody.innerHTML = "<tr><td colspan='3'>Belum ada data</td></tr>";
        document.getElementById("saldoAwalPreview").style.display = "none";
        return;
      }
      tbody.innerHTML = saldoAwalData
        .filter(item => item.kode && item.nama && item.jumlah)
        .map(item =>
          `<tr><td>${item.kode}</td><td>${item.nama}</td><td>${item.jumlah}</td></tr>`
        ).join("");
      document.getElementById("saldoAwalPreview").style.display = "";
    }

    // Simpan saldo ke localStorage
    document.getElementById("saveSaldoBtn").addEventListener("click", function() {
      if (!saldoAwalData || saldoAwalData.length === 0) {
        alert("Belum ada data saldo awal yang diupload!");
        return;
      }
      const jenis = getJenisSaldo();
      const key = jenis === "perlengkapan"
        ? `saldoAwal_perlengkapan_${fileName}`
        : `saldoAwal_persediaan_${fileName}`;
      localStorage.setItem(key, JSON.stringify(saldoAwalData));
      alert("Saldo awal berhasil disimpan di localStorage.");
    });

    // Upload saldo awal ke Supabase Storage
    async function uploadSaldoAwalKeCloud() {
      const statusEl = document.getElementById("uploadSaldoStatus");
      statusEl.textContent = "Uploading...";
      const jenis = getJenisSaldo();
      const key = jenis === "perlengkapan"
        ? `saldoAwal_perlengkapan_${fileName}`
        : `saldoAwal_persediaan_${fileName}`;
      const folder = jenis === "perlengkapan"
        ? "saldo-awal/perlengkapan"
        : "saldo-awal/persediaan";
      const data = localStorage.getItem(key);
      if (!data) {
        statusEl.textContent = "❌ Data saldo awal belum ada di localStorage!";
        return;
      }
      const filePath = `${folder}/saldo-awal-${fileName}-${Date.now()}.json`;
      const { error } = await supabase.storage.from(BUCKET_NAME).upload(filePath, data, {
        contentType: "application/json",
        upsert: true
      });
      if (error) {
        statusEl.textContent = "❌ Upload gagal: " + error.message;
      } else {
        statusEl.textContent = "✔️ Berhasil upload saldo awal ke cloud";
        setTimeout(() => statusEl.textContent = "", 2000);
      }
    }

    document.getElementById("uploadSaldoAwalCloud").addEventListener("click", uploadSaldoAwalKeCloud);
  </script>
</body>
</html>
