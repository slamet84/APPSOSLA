<!DOCTYPE html>
<html lang="id">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>APPSOSLA</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <script>
    if (localStorage.getItem("login") !== "true") {
      window.location.href = "login.html";
    }
  </script>

  <div class="container">
    <h1>APPSOSLA</h1>

    <!-- Tombol Logout -->
    <div style="text-align: right;">
      <button onclick="logout()" style="background-color:red; color:white; border:none; padding:6px 12px; border-radius:4px;">üîì Logout</button>
    </div>
    
    <!-- Tombol Akses Cepat -->
    <div class="actions">
      <a href="master-inventory.html" class="btn">üìÅ Master Inventory</a>
      <a href="create-file.html" class="btn">‚ûï Buat File Baru</a>
    </div>

    <!-- Upload ke Supabase Storage -->
    <h2>‚òÅÔ∏è Upload File ke Supabase + Simpan ke Lokal</h2>
    <input type="file" id="fileInput" />
    <button id="uploadBtn">Upload</button>
    <div class="progress" id="progress"></div>
    <div class="url" id="fileUrl"></div>
    <hr/>

    <!-- Daftar File Opname -->
    <h2>üìÇ Daftar File Opname (Lokal & Cloud)</h2>
    <ul id="fileList" class="file-list"></ul>
  </div>
  
  <!-- Tambahkan footer dengan link Privacy Policy -->
  <footer style="text-align:center; margin-top:2rem;">
    <a href="privacy-policy.html">Privacy Policy</a>
  </footer>
  
  <script>
    function logout() {
      localStorage.removeItem("login");
      localStorage.removeItem("userEmail");
      window.location.href = "login.html";    
    }
  </script>

  <!-- Script Supabase Upload + Hybrid Storage -->
  <script>
    // Ganti dengan properti project Supabase Anda
    const SUPABASE_URL = 'https://xxxx.supabase.co'; // Ganti!
    const SUPABASE_ANON_KEY = 'public-anon-key';     // Ganti!
    const BUCKET_NAME = 'uploads';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    document.getElementById('uploadBtn').addEventListener('click', async () => {
      const fileInput = document.getElementById('fileInput');
      const progress = document.getElementById('progress');
      const fileUrl = document.getElementById('fileUrl');
      progress.textContent = '';
      fileUrl.textContent = '';

      if (!fileInput.files.length) {
        progress.textContent = 'Pilih file terlebih dahulu!';
        return;
      }

      const file = fileInput.files[0];
      const now = new Date();
      const tanggal = now.toLocaleDateString("id-ID") + " " + now.toLocaleTimeString("id-ID");
      const path = `user-uploads/${Date.now()}-${file.name}`;

      progress.textContent = 'Uploading...';

      // Upload ke Supabase
      const { data, error } = await supabase
        .storage
        .from(BUCKET_NAME)
        .upload(path, file);

      if (error) {
        progress.textContent = 'Gagal upload: ' + error.message;
        return;
      }

      progress.textContent = 'Upload berhasil!';

      // Dapatkan public URL
      const { data: publicData } = supabase
        .storage
        .from(BUCKET_NAME)
        .getPublicUrl(path);

      fileUrl.innerHTML = `Public URL: <a href="${publicData.publicUrl}" target="_blank">${publicData.publicUrl}</a>`;

      // Simpan metadata file ke localStorage
      const files = JSON.parse(localStorage.getItem("stockOpnameFiles")) || [];
      files.push({
        name: file.name,
        date: tanggal,
        publicUrl: publicData.publicUrl
      });
      localStorage.setItem("stockOpnameFiles", JSON.stringify(files));
      loadFiles();
    });

    function loadFiles() {
      const fileList = document.getElementById("fileList");
      const files = JSON.parse(localStorage.getItem("stockOpnameFiles")) || [];

      fileList.innerHTML = "";

      if (files.length === 0) {
        fileList.innerHTML = "<p>Belum ada file dibuat.</p>";
        return;
      }

      files.forEach((file, index) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${file.name}</strong><br/>
          <small>Tanggal: ${file.date}</small><br/>
          <a href="${file.publicUrl}" target="_blank" style="color:blue;">Lihat di Cloud</a>
        `;
        fileList.appendChild(li);
      });
    }

    window.onload = () => {
      loadFiles();
    };
  </script>
</body>
</html>
