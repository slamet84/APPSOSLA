<!DOCTYPE html>
<html lang="id">
<head>
  <!-- ... head sama seperti sebelumnya ... -->
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ... style sama seperti sebelumnya ... */
  </style>
</head>
<body>
<div class="container">
  <!-- ... UI sama seperti sebelumnya ... -->
  <!-- tab navigasi dan tabel saldo awal ... -->
  <div id="hasilopname" class="tab-content">
    <h2>üìä Hasil Opname Perlengkapan</h2>
    <button onclick="exportHasilOpname()">‚¨áÔ∏è Export Excel</button>
    <table><thead><tr><th>Kode</th><th>Nama</th><th>Saldo</th><th>Input</th><th>Selisih</th></tr></thead><tbody id="hasilOpnameTable"></tbody></table>
  </div>
  <div id="hasilopnameps" class="tab-content">
    <h2>üìä Hasil Opname Persediaan</h2>
    <button onclick="exportHasilOpnamePs()">‚¨áÔ∏è Export Excel</button>
    <table><thead><tr><th>Kode</th><th>Nama</th><th>Saldo</th><th>Input</th><th>Selisih</th></tr></thead><tbody id="hasilOpnameTablePs"></tbody></table>
  </div>
<script>
// ... kode setup Supabase dan fileName ...

// ==== FUNGSI HASIL OPNAME PERLENGKAPAN ====
function refreshHasilOpname() {
  const saldo = (JSON.parse(localStorage.getItem(`saldoAwal_perlengkapan_${fileName}`)) || []).map(normalizeKey);
  const allData = JSON.parse(localStorage.getItem(`opnameData_${fileName}`)) || [];
  // Filter hanya kategori Perlengkapan dan Room
  const inputData = allData.filter(e => e.kategori === "Perlengkapan" || e.kategori === "Room");
  const total = {};
  inputData.forEach(item => {
    if (!total[item.kode]) total[item.kode] = { jumlah: 0, nama: item.nama };
    total[item.kode].jumlah += parseInt(item.stokFisik || 0);
  });

  // Gabung saldo awal dan input opname
  const hasil = {};
  saldo.forEach(item => {
    hasil[item.kode] = {
      kode: item.kode,
      nama: item.nama,
      saldoAwal: item.jumlah,
      totalInput: total[item.kode]?.jumlah || 0,
      selisih: item.jumlah - (total[item.kode]?.jumlah || 0)
    };
  });
  // Tambahkan kode yang hanya ada di input opname
  Object.keys(total).forEach(kode => {
    if (!hasil[kode]) {
      hasil[kode] = {
        kode,
        nama: total[kode].nama,
        saldoAwal: 0,
        totalInput: total[kode].jumlah,
        selisih: -total[kode].jumlah
      };
    }
  });

  const tbody = document.getElementById("hasilOpnameTable");
  tbody.innerHTML = Object.values(hasil)
    .filter(r => r.saldoAwal !== 0 || r.totalInput !== 0)
    .map(r => `
      <tr>
        <td>${r.kode}</td>
        <td>${r.nama}</td>
        <td>${r.saldoAwal}</td>
        <td>${r.totalInput}</td>
        <td>${r.selisih}</td>
      </tr>
    `).join("");
}

// ==== FUNGSI HASIL OPNAME PERSEDIAAN ====
function refreshHasilOpnamePs() {
  const saldo = (JSON.parse(localStorage.getItem(`saldoAwal_persediaan_${fileName}`)) || []).map(normalizeKey);
  const allData = JSON.parse(localStorage.getItem(`opnameData_${fileName}`)) || [];
  const inputData = allData.filter(e => e.kategori === "Persediaan");
  const total = {};
  inputData.forEach(item => {
    if (!total[item.kode]) total[item.kode] = { jumlah: 0, nama: item.nama };
    total[item.kode].jumlah += parseInt(item.stokFisik || 0);
  });

  const hasil = {};
  saldo.forEach(item => {
    hasil[item.kode] = {
      kode: item.kode,
      nama: item.nama,
      saldoAwal: item.jumlah,
      totalInput: total[item.kode]?.jumlah || 0,
      selisih: item.jumlah - (total[item.kode]?.jumlah || 0)
    };
  });
  Object.keys(total).forEach(kode => {
    if (!hasil[kode]) {
      hasil[kode] = {
        kode,
        nama: total[kode].nama,
        saldoAwal: 0,
        totalInput: total[kode].jumlah,
        selisih: -total[kode].jumlah
      };
    }
  });

  const tbody = document.getElementById("hasilOpnameTablePs");
  tbody.innerHTML = Object.values(hasil)
    .filter(r => r.saldoAwal !== 0 || r.totalInput !== 0)
    .map(r => `
      <tr>
        <td>${r.kode}</td>
        <td>${r.nama}</td>
        <td>${r.saldoAwal}</td>
        <td>${r.totalInput}</td>
        <td>${r.selisih}</td>
      </tr>
    `).join("");
}

// -- Pastikan fungsi ini juga dipanggil setelah cloud sync! --

// ==== SINKRONISASI CLOUD ====
async function syncFileOpnameFromCloud() {
  // ... sama seperti kode kamu ...
  if (!error && data) {
    try {
      const text = await data.text();
      const obj = JSON.parse(text);
      if (obj.saldoAwal_perlengkapan) localStorage.setItem(`saldoAwal_perlengkapan_${fileName}`, JSON.stringify(obj.saldoAwal_perlengkapan));
      if (obj.saldoAwal_persediaan) localStorage.setItem(`saldoAwal_persediaan_${fileName}`, JSON.stringify(obj.saldoAwal_persediaan));
      if (obj.opnameData_perlengkapan) localStorage.setItem(`opnameData_perlengkapan_${fileName}`, JSON.stringify(obj.opnameData_perlengkapan));
      if (obj.opnameData_persediaan) localStorage.setItem(`opnameData_persediaan_${fileName}`, JSON.stringify(obj.opnameData_persediaan));
      if (obj.opnameData_room) localStorage.setItem(`opnameData_room_${fileName}`, JSON.stringify(obj.opnameData_room));
      // merge
      if (obj.opnameData_perlengkapan || obj.opnameData_room || obj.opnameData_persediaan) {
        let merged = [];
        if (obj.opnameData_perlengkapan) merged = merged.concat(obj.opnameData_perlengkapan.map(x => ({...x, kategori: "Perlengkapan"})));
        if (obj.opnameData_room) merged = merged.concat(obj.opnameData_room.map(x => ({...x, kategori: "Room"})));
        if (obj.opnameData_persediaan) merged = merged.concat(obj.opnameData_persediaan.map(x => ({...x, kategori: "Persediaan"})));
        if (merged.length) localStorage.setItem(`opnameData_${fileName}`, JSON.stringify(merged));
      }
    } catch (e) { }
  }
}

// ==== Panggil refresh setelah sync cloud DAN saat upload saldo awal! ====
syncFileOpnameFromCloud().then(()=>{
  displaySaldoAwal();
  displaySaldoAwalPs();
  refreshHasilOpname();
  refreshHasilOpnamePs();
});

// ==== Juga panggil saat upload saldo awal (biar real-time update) ====
document.getElementById("uploadSaldo").addEventListener("change", function(e) {
  // ... setelah displaySaldoAwal();
  displaySaldoAwal();
  uploadFileOpnameToCloud();
  refreshHasilOpname();
});
document.getElementById("uploadSaldoPs").addEventListener("change", function(e) {
  // ... setelah displaySaldoAwalPs();
  displaySaldoAwalPs();
  uploadFileOpnameToCloud();
  refreshHasilOpnamePs();
});

// ==== Juga panggil setelah clear saldo awal ====
function clearSaldoAwal() {
  localStorage.removeItem(`saldoAwal_perlengkapan_${fileName}`);
  displaySaldoAwal();
  uploadFileOpnameToCloud();
  refreshHasilOpname();
}
function clearSaldoAwalPs() {
  localStorage.removeItem(`saldoAwal_persediaan_${fileName}`);
  displaySaldoAwalPs();
  uploadFileOpnameToCloud();
  refreshHasilOpnamePs();
}
</script>
</body>
</html>
