<!DOCTYPE html>
<html lang="id">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>📋 Menu Input Opname</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .btn { padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; margin: 5px; cursor: pointer; }
    .tab-nav { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
    .tab-nav button.active { background-color: #0056b3; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
  </style>
</head>
<body>
<div class="container">
  <h1>📋 Menu Input Opname</h1>
  <!-- Tombol sinkron cloud (download & upload) -->
  <button class="btn" id="btnSyncDownload">⬇️ Ambil Dari Cloud</button>
  <button class="btn" id="btnSyncUpload">⬆️ Upload ke Cloud</button>

  <p><strong>Nama File:</strong> <span id="fileNameDisplay"></span></p>
  <a href="index.html" class="btn">← Kembali ke Dashboard</a>

  <div class="tab-nav">
    <button onclick="showTab('menu')" class="active">📂 Menu</button>
    <button onclick="showTab('saldoawal')">📥 Saldo Awal Perlengkapan OS</button>
    <button onclick="showTab('saldoawalps')">📥 Saldo Awal Persediaan OS</button>
    <button onclick="showTab('hasilopname')">📊 Hasil Opname Perlengkapan</button>
    <button onclick="showTab('hasilopnameps')">📊 Hasil Opname Persediaan</button>
  </div>

  <div id="menu" class="tab-content active">
    <a class="btn" id="btnPrl">🧾 Input Perlengkapan</a>
    <a class="btn" id="btnPs">📦 Input Persediaan</a>
    <a class="btn" id="btnRoom">🏠 Input Room</a>
  </div>
  <div id="saldoawal" class="tab-content">
    <h2>📥 Saldo Awal Perlengkapan OS</h2>
    <input type="file" id="uploadSaldo" accept=".xlsx">
    <button onclick="clearSaldoAwal()">🗑️ Hapus Data</button>
    <table><thead><tr><th>Kode</th><th>Nama</th><th>Jumlah</th></tr></thead><tbody id="saldoAwalTable"></tbody></table>
  </div>

  <div id="saldoawalps" class="tab-content">
    <h2>📥 Saldo Awal Persediaan OS</h2>
    <input type="file" id="uploadSaldoPs" accept=".xlsx">
    <button onclick="clearSaldoAwalPs()">🗑️ Hapus Data</button>
    <table><thead><tr><th>Kode</th><th>Nama</th><th>Jumlah</th></tr></thead><tbody id="saldoAwalTablePs"></tbody></table>
  </div>

  <div id="hasilopname" class="tab-content">
    <h2>📊 Hasil Opname Perlengkapan</h2>
    <button onclick="exportHasilOpname()">⬇️ Export Excel</button>
    <table><thead><tr><th>Kode</th><th>Nama</th><th>Saldo</th><th>Input</th><th>Selisih</th></tr></thead><tbody id="hasilOpnameTable"></tbody></table>
  </div>

  <div id="hasilopnameps" class="tab-content">
    <h2>📊 Hasil Opname Persediaan</h2>
    <button onclick="exportHasilOpnamePs()">⬇️ Export Excel</button>
    <table><thead><tr><th>Kode</th><th>Nama</th><th>Saldo</th><th>Input</th><th>Selisih</th></tr></thead><tbody id="hasilOpnameTablePs"></tbody></table>
  </div>
<script>
// === SUPABASE SETUP ===
const SUPABASE_URL = "https://yxwxqlufyzxroomjbuqh.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4d3hxbHVmeXp4cm9vbWpidXFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwNDYxNDUsImV4cCI6MjA2NTYyMjE0NX0.wIlqtvkERpdHPaGyg8JufZL10M1noTi6hvTD6HPC36Q";
const BUCKET_NAME = "uploads";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// === FILE HANDLING ===
const fileName = decodeURIComponent(new URLSearchParams(window.location.search).get("file") || "data");
document.getElementById("fileNameDisplay").textContent = fileName;
document.getElementById("btnPrl").href = `input-perlengkapan.html?file=${fileName}`;
document.getElementById("btnPs").href = `input-persediaan.html?file=${fileName}`;
document.getElementById("btnRoom").href = `input-room.html?file=${fileName}`;

function showTab(id) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".tab-nav button").forEach(btn => btn.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  event.target.classList.add("active");
  if (id === "hasilopname") refreshHasilOpname();
  if (id === "hasilopnameps") refreshHasilOpnamePs();
}

// UTIL untuk normalisasi key (misal: dari Excel)
function normalizeKey(obj) {
  const out = {};
  for (let key in obj) {
    const norm = key.trim().toLowerCase();
    if (norm === 'kode') out.kode = obj[key];
    if (norm.includes('nama')) out.nama = obj[key];
    if (norm.includes('jumlah')) out.jumlah = parseInt(obj[key]) || 0;
  }
  return out;
}

// ==== SALDO AWAL PERLENGKAPAN ====
function displaySaldoAwal() {
  const data = JSON.parse(localStorage.getItem(`saldoAwal_perlengkapan_${fileName}`)) || [];
  const tbody = document.getElementById("saldoAwalTable");
  tbody.innerHTML = data.map(d => {
    const item = normalizeKey(d);
    return `<tr><td>${item.kode || ""}</td><td>${item.nama || ""}</td><td>${item.jumlah || 0}</td></tr>`;
  }).join("");
}
function clearSaldoAwal() {
  localStorage.removeItem(`saldoAwal_perlengkapan_${fileName}`);
  displaySaldoAwal();
  uploadFileOpnameToCloud();
}
document.getElementById("uploadSaldo").addEventListener("change", function(e) {
  const reader = new FileReader();
  reader.onload = function(evt) {
    const wb = XLSX.read(evt.target.result, { type: "array" });
    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    localStorage.setItem(`saldoAwal_perlengkapan_${fileName}`, JSON.stringify(data));
    displaySaldoAwal();
    uploadFileOpnameToCloud();
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});
displaySaldoAwal();

// ==== SALDO AWAL PERSEDIAAN ====
function displaySaldoAwalPs() {
  const data = JSON.parse(localStorage.getItem(`saldoAwal_persediaan_${fileName}`)) || [];
  const tbody = document.getElementById("saldoAwalTablePs");
  tbody.innerHTML = data.map(d => {
    const item = normalizeKey(d);
    return `<tr><td>${item.kode || ""}</td><td>${item.nama || ""}</td><td>${item.jumlah || 0}</td></tr>`;
  }).join("");
}
function clearSaldoAwalPs() {
  localStorage.removeItem(`saldoAwal_persediaan_${fileName}`);
  displaySaldoAwalPs();
  uploadFileOpnameToCloud();
}
document.getElementById("uploadSaldoPs").addEventListener("change", function(e) {
  const reader = new FileReader();
  reader.onload = function(evt) {
    const wb = XLSX.read(evt.target.result, { type: "array" });
    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    localStorage.setItem(`saldoAwal_persediaan_${fileName}`, JSON.stringify(data));
    displaySaldoAwalPs();
    uploadFileOpnameToCloud();
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});
displaySaldoAwalPs();

// === SINKRONISASI CLOUD ===
function getAllOpnameData() {
  return {
    saldoAwal_perlengkapan: JSON.parse(localStorage.getItem(`saldoAwal_perlengkapan_${fileName}`) || "[]"),
    saldoAwal_persediaan: JSON.parse(localStorage.getItem(`saldoAwal_persediaan_${fileName}`) || "[]"),
    opnameData_perlengkapan: JSON.parse(localStorage.getItem(`opnameData_perlengkapan_${fileName}`) || "[]"),
    opnameData_persediaan: JSON.parse(localStorage.getItem(`opnameData_persediaan_${fileName}`) || "[]"),
    opnameData_room: JSON.parse(localStorage.getItem(`opnameData_room_${fileName}`) || "[]")
  };
}

async function uploadFileOpnameToCloud() {
  const data = getAllOpnameData();
  const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
  const path = fileName.endsWith('.json') 
    ? `opname-files/${fileName}`
    : `opname-files/${fileName}.json`;
  const { error } = await supabase.storage.from(BUCKET_NAME).upload(path, blob, { upsert: true });
  if (error) {
    console.error("Gagal sync cloud:", error.message);
  }
}

async function syncFileOpnameFromCloud() {
  const path = fileName.endsWith('.json') 
    ? `opname-files/${fileName}`
    : `opname-files/${fileName}.json`;
  const { data, error } = await supabase.storage.from(BUCKET_NAME).download(path);
  if (!error && data) {
    try {
      const text = await data.text();
      const obj = JSON.parse(text);
      if (obj.saldoAwal_perlengkapan) localStorage.setItem(`saldoAwal_perlengkapan_${fileName}`, JSON.stringify(obj.saldoAwal_perlengkapan));
      if (obj.saldoAwal_persediaan) localStorage.setItem(`saldoAwal_persediaan_${fileName}`, JSON.stringify(obj.saldoAwal_persediaan));
      if (obj.opnameData_perlengkapan) localStorage.setItem(`opnameData_perlengkapan_${fileName}`, JSON.stringify(obj.opnameData_perlengkapan));
      if (obj.opnameData_persediaan) localStorage.setItem(`opnameData_persediaan_${fileName}`, JSON.stringify(obj.opnameData_persediaan));
      if (obj.opnameData_room) localStorage.setItem(`opnameData_room_${fileName}`, JSON.stringify(obj.opnameData_room));
      // Jika sudah migrasi ke satu file, update juga key opnameData_${fileName}
      if (obj.opnameData_perlengkapan || obj.opnameData_room || obj.opnameData_persediaan) {
        let merged = [];
        if (obj.opnameData_perlengkapan) merged = merged.concat(obj.opnameData_perlengkapan.map(x => ({...x, kategori: "Perlengkapan"})));
        if (obj.opnameData_room) merged = merged.concat(obj.opnameData_room.map(x => ({...x, kategori: "Room"})));
        if (obj.opnameData_persediaan) merged = merged.concat(obj.opnameData_persediaan.map(x => ({...x, kategori: "Persediaan"})));
        if (merged.length) localStorage.setItem(`opnameData_${fileName}`, JSON.stringify(merged));
      }
    } catch (e) {
      // ignore
    }
  }
}

// Panggil saat load pertama & setelah sync cloud
syncFileOpnameFromCloud().then(()=>{
  displaySaldoAwal();
  displaySaldoAwalPs();
  // ...refresh hasil opname kalau ada
});

// SINKRONISASI BUTTON
document.getElementById("btnSyncDownload").addEventListener("click", async function() {
  this.disabled = true;
  this.textContent = "⏳ Mengambil dari Cloud...";
  await syncFileOpnameFromCloud();
  displaySaldoAwal();
  displaySaldoAwalPs();
  this.disabled = false;
  this.textContent = "⬇️ Ambil Dari Cloud";
  alert("Data telah diambil dari cloud dan diperbarui.");
});

document.getElementById("btnSyncUpload").addEventListener("click", async function() {
  this.disabled = true;
  this.textContent = "⏳ Upload ke Cloud...";
  await uploadFileOpnameToCloud();
  this.disabled = false;
  this.textContent = "⬆️ Upload ke Cloud";
  alert("Data berhasil di-upload ke cloud.");
});
</script>
</body>
</html>
