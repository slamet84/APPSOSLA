<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>➕ Buat File Baru</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="container">
    <h1>➕ Buat File Baru</h1>
    <a href="index.html" class="btn">← Kembali</a>

    <form id="createForm">
      <label for="fileName">Nama File:</label>
      <input type="text" id="fileName" required />

      <label for="fileDate">Tanggal Opname:</label>
      <input type="date" id="fileDate" required />

      <button type="submit">💾 Simpan File</button>
    </form>
    <div id="progress" style="margin-top:1rem; color:#00806a;"></div>
    <div id="error" style="color:red;"></div>
  </div>

  <script>
    // Ganti sesuai dengan project Anda
    const SUPABASE_URL = 'https://yxwxqlufyzxroomjbuqh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4d3hxbHVmeXp4cm9vbWpidXFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwNDYxNDUsImV4cCI6MjA2NTYyMjE0NX0.wIlqtvkERpdHPaGyg8JufZL10M1noTi6hvTD6HPC36Q';
    const BUCKET_NAME = 'uploads';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Proteksi halaman: cek session Supabase
    document.addEventListener('DOMContentLoaded', async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = "login.html";
      }
    });

    document.getElementById("createForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      document.getElementById("progress").textContent = "";
      document.getElementById("error").textContent = "";

      const fileName = document.getElementById("fileName").value.trim();
      const fileDate = document.getElementById("fileDate").value;

      if (!fileName || !fileDate) {
        alert("❌ Nama file dan tanggal harus diisi.");
        return;
      }

      // Format nama file unik
      const niceFileName = `${fileName.replace(/[^a-zA-Z0-9_-]/g, "_")}-${fileDate}.csv`;
      const path = `user-files/${Date.now()}-${niceFileName}`;

      // Data CSV dummy, sesuaikan struktur jika perlu
      const csvRows = [
        ["No", "Kode", "Nama Barang", "Jumlah"],
        ["1", "INV001", "Laptop", "10"],
        ["2", "INV002", "Printer", "5"]
      ];
      const csvContent = csvRows.map(e => e.join(",")).join("\n");
      const blob = new Blob([csvContent], {type: "text/csv"});

      document.getElementById("progress").textContent = "Mengupload ke cloud...";

      // Upload ke Supabase Storage
      const { data, error } = await supabase
        .storage
        .from(BUCKET_NAME)
        .upload(path, blob);

      if (error) {
        document.getElementById("progress").textContent = "";
        document.getElementById("error").textContent = "❌ Gagal upload: " + error.message;
        return;
      }

      // Public URL
      const { data: publicData } = supabase
        .storage
        .from(BUCKET_NAME)
        .getPublicUrl(path);

      document.getElementById("progress").textContent = "✅ File berhasil di-upload ke cloud.";

      // Anda TIDAK PERLU lagi simpan ke localStorage, cukup reload/tampilkan di dashboard dari cloud

      setTimeout(() => { window.location.href = "index.html"; }, 1300);
    });
  </script>
</body>
</html>
